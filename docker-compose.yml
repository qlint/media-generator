services:
  redis:
    image: redis:7
    ports:
      - "6380:6379"   # host 6380 to avoid conflict with existing redis on 6379

  rq-dashboard:
    build:
      context: .
      dockerfile: Dockerfile.rq-dashboard
    ports:
      - "9181:9181"
    depends_on:
      - redis

  ollama:
    image: ollama/ollama:latest
    # Ensure Ollama listens on all interfaces inside the container so other containers can reach it.
    environment:
      - OLLAMA_HOST=0.0.0.0:11434
    ports:
      - "11435:11434" # host 11435 to avoid conflict with existing ollama on 11434
    volumes:
      - ollama:/root/.ollama

  # One-shot init container: waits for Ollama's HTTP API, then pulls the planner model via /api/pull.
  # This enables a single command: `docker compose up --build`
  ollama-init:
    image: curlimages/curl:8.5.0
    depends_on:
      - ollama
    entrypoint: ["/bin/sh", "-lc"]
    command: >
      "MODEL='${LLM_MODEL:-phi4-mini:3.8b}';
       echo "ollama-init: waiting for ollama HTTP API...";
       until curl -sSf http://ollama:11434/api/tags >/tmp/tags.json; do echo 'waiting for ollama...'; sleep 2; done;
       if grep -q "\"name\":\"$MODEL\"" /tmp/tags.json; then
         echo "ollama-init: model already present: $MODEL";
       else
         echo "ollama-init: pulling model: $MODEL";
         curl -sSf http://ollama:11434/api/pull -H 'Content-Type: application/json' -d "{\"model\":\"$MODEL\",\"stream\":false}" >/dev/null;
         echo "ollama-init: pull complete: $MODEL";
       fi"
    restart: "no"

  api:
    build: .
    env_file:
      - .env
    environment:
      - REDIS_URL=redis://redis:6379/0
      - OLLAMA_URL=http://ollama:11434
      - ASSETS_BASE_DIR=/data/assets
      - HF_HOME=/data/hf
    volumes:
      - ./assets:/data/assets
      - hf_cache:/data/hf
    ports:
      - "8000:8000"
    depends_on:
      redis:
        condition: service_started
      ollama-init:
        condition: service_completed_successfully
    gpus: all

  worker:
    build: .
    command: ["python", "-m", "rq", "worker", "recipe-assets"]
    env_file:
      - .env
    environment:
      - REDIS_URL=redis://redis:6379/0
      - OLLAMA_URL=http://ollama:11434
      - ASSETS_BASE_DIR=/data/assets
      - HF_HOME=/data/hf
    volumes:
      - ./assets:/data/assets
      - hf_cache:/data/hf
    depends_on:
      redis:
        condition: service_started
      ollama-init:
        condition: service_completed_successfully
    gpus: all

volumes:
  hf_cache:
  ollama:
