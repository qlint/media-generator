services:
  redis:
    image: redis:7
    ports:
      - "6380:6379"   # host 6380 to avoid conflict with existing redis on 6379

  rq-dashboard:
    build:
      context: .
      dockerfile: Dockerfile.rq-dashboard
    ports:
      - "9181:9181"
    depends_on:
      - redis

  ollama:
    image: ollama/ollama:latest
    # Ensure Ollama listens on all interfaces inside the container so other containers can reach it.
    environment:
      - OLLAMA_HOST=0.0.0.0:11434
    ports:
      - "11435:11434" # host 11435 to avoid conflict with existing ollama on 11434
    volumes:
      - ollama:/root/.ollama

  # One-shot init container: waits for Ollama's HTTP API, then pulls the planner model via /api/pull.
  # Prints streaming progress so it doesn't look "stuck".
  ollama-init:
    image: curlimages/curl:8.5.0
    depends_on:
      - ollama
    entrypoint: ["/bin/sh", "-lc"]
    command: >
      "MODEL='${LLM_MODEL:-phi4-mini:3.8b}';
       echo 'ollama-init: waiting for ollama HTTP API...';
       until curl -sSf http://ollama:11434/api/tags >/tmp/tags.json >/dev/null; do echo 'waiting for ollama...'; sleep 2; done;
       if grep -q \"\\\"name\\\":\\\"$$MODEL\\\"\" /tmp/tags.json; then
         echo \"ollama-init: model already present: $$MODEL\";
       else
         echo \"ollama-init: pulling model with progress: $$MODEL\";
         curl -sS -N http://ollama:11434/api/pull -H 'Content-Type: application/json' -d \"{\\\"model\\\":\\\"$$MODEL\\\"}\" |
           while IFS= read -r line; do
             status=$$(echo \"$$line\" | sed -n 's/.*\"status\":\"\\([^\"]*\\)\".*/\\1/p');
             completed=$$(echo \"$$line\" | sed -n 's/.*\"completed\":\\([0-9][0-9]*\\).*/\\1/p');
             total=$$(echo \"$$line\" | sed -n 's/.*\"total\":\\([0-9][0-9]*\\).*/\\1/p');
             if [ -n \"$$status\" ] && [ -n \"$$completed\" ] && [ -n \"$$total\" ] && [ \"$$total\" -gt 0 ] 2>/dev/null; then
               pct=$$(( $$completed * 100 / $$total ));
               echo \"ollama-init: $$status ($$pct%)\";
             elif [ -n \"$$status\" ]; then
               echo \"ollama-init: $$status\";
             else
               echo \"ollama-init: $$line\";
             fi
           done;
         echo \"ollama-init: pull complete: $$MODEL\";
       fi"
    restart: "no"

  api:
    build: .
    env_file:
      - .env
    environment:
      - REDIS_URL=redis://redis:6379/0
      - OLLAMA_URL=http://ollama:11434
      - ASSETS_BASE_DIR=/data/assets
      - HF_HOME=/data/hf
    volumes:
      - ./assets:/data/assets
      - hf_cache:/data/hf
    ports:
      - "8000:8000"
    depends_on:
      redis:
        condition: service_started
      ollama-init:
        condition: service_completed_successfully

  worker:
    build: .
    command: ["rq", "worker", "recipe-assets"]
    env_file:
      - .env
    environment:
      - REDIS_URL=redis://redis:6379/0
      - OLLAMA_URL=http://ollama:11434
      - ASSETS_BASE_DIR=/data/assets
      - HF_HOME=/data/hf
    volumes:
      - ./assets:/data/assets
      - hf_cache:/data/hf
    depends_on:
      redis:
        condition: service_started
      ollama-init:
        condition: service_completed_successfully

volumes:
  hf_cache:
  ollama:
